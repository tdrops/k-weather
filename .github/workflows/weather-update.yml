name: Weather Data Update

# 주기 실행(스케줄) 및 수동 실행 가능
on:
  schedule:
    - cron: '10 2,5,8,11,14,17,20,23 * * *'  # 주의: GitHub Actions는 UTC 기준입니다
  workflow_dispatch:

jobs:
  update-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Call Weather API Webhook
        env:
          WEATHER_KEY: ${{ secrets.WEATHER_CRON_KEY }}
        run: |
          # 안전한 호출: 실패 시 작업 실패로 처리하고, 재시도 옵션 추가
          curl -sS --fail --show-error \
            --retry 3 --retry-delay 10 \
            "https://www.k-weather.co.kr/app/cron_trigger.php?key=${WEATHER_KEY}" \
            -H "User-Agent: GitHub-Actions" -o response.txt || (echo "Request failed with exit $?" && exit 1)

          echo "HTTP response body (first 200 chars):"
          head -c 200 response.txt || true

      - name: Log result
        run: echo "Weather data update triggered at $(date -u) (UTC)"
